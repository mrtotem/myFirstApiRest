var express = require('express');
var user = require('./node_modules/scripts/models/User');
var message = require('./node_modules/scripts/models/Message');

module.exports.onUserArrived = function(req, res){

	user.findById({_id : req.params._userId}, function(err, userTemp){

			if(err){
				return	res.status(400).send(err);
			}
			if(!userTemp){
				return res.status(400).send(err);
			}
			if(req.body.lat != null && req.body.long != null){

				return res.status(200).send({
				message : 'User arrived',
				lat : req.body.lat,
				long : req.body.long
				});
			}else{

				return res.status(200).send({message : 'User arrived'});
			}
			
	});
}

module.exports.updateAlertMessage = function(req, res){

	user.findById({_id : req.params._userId}, function(err, userTemp){

			if(err){
				return	res.status(400).send(err);
			}
			if(!userTemp){
				return res.status(400).send(err);
			}

			message.findById({_id : req.params._alertId}, function(err, messageTemp){

				if(err){
					return	res.status(400).send(err);
				}
				if(!messageTemp){
					return res.status(400).send(err);
				}

				if(req.body.message != null){
					messageTemp.message = req.body.message;
				}
				if(req.body.date != null){
					messageTemp.date = req.body.date;
				}
				if(req.body.lat != null){
					messageTemp.lat = req.body.lat;
				}
				if(req.body.long != null){
					messageTemp.long = req.body.long;
				}

				// save alert object y checkeo de errores
				messageTemp.save(function(err){
								
					if(err){

						return res.status(400).send(err);
					}else{

						console.log("after alert object creation");
						return res
							.status(200)
					        .json(messageTemp);
						}
					});
				});
	});
}

module.exports.onUserAlerted = function(req, res){

	user.findById({_id : req.params._userId}, function(err, userTemp){

			if(err){
				return	res.status(400).send(err);
			}
			if(!userTemp){
				return res.status(400).send(err);
			}

			var messageTemp = new message({
								userId : userTemp._id,
								date : req.body.date
							});

			console.log(messageTemp);

			// save alert object y checkeo de errores
			messageTemp.save(function(err){
						
				if(err){

					return res.status(400).send(err);
				}else{

					console.log("after alert object creation");
					return res
						.status(200)
			           	.json(messageTemp);
				}
			});
	});
}

module.exports.getUserAlerts = function(req, res){

	message.find(function(err, messages){

		if(err){
			return res.status(400).send(err);
		}
		if(!messages){
			return res.status(400).send({ message : 'No se encontraron mensajes de alerta'});
		}

		return res.status(200).json(messages);
	});
}